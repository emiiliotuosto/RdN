We give semantics to global types using \emph{partially-ordered
  multi-set} (pomsets for short).
%
Following~\cite{gaifman1987partial}, a \emph{pomset} is an isomorphism
class of labelled partially-ordered sets (lposet) where, fixed a set
of labels $\lset$,
\begin{itemize}
\item an lposet is a triple $(\eset, \leq, \alf)$, with $\eset$ a set
  of events, $\leq$ is a partial order on $\eset$, and
  $\alf: \eset \rightarrow \lset$ a labelling function mapping events
  in $\eset$ to labels in $\lset$;
\item two lposets $(\eset, \leq, \alf)$ and $(\eset', \leq', \alf')$
  are \emph{isomorphic} if there is a bijection
  $\phi: \eset \rightarrow \eset'$ such that
  $\ae \leq \ae' \iff \phi(\ae) \leq' \phi(\ae')$ and
  $\alf = \alf' \circ \phi$.
\end{itemize}
%
Intuitively, the partial order $\leq$ yields a causality relation
among events; for $\ae \neq \ae'$, if $\ae \leq \ae'$ then $\ae'$ is
caused by $\ae$ or, in other words, the occurrence of $\ae'$ must be
preceded by the one of $\ae$ in any execution respecting the order
$\leq$.
%
Note that $\alf$ is not required to be injective: for
$\ae \neq \ae' \in \eset$, $\alf(\ae) = \alf(\ae')$ means that $\ae$
and $\ae'$ model different occurrences of the same action.
%
In the following, $[\eset, \leq, \alf]$ denotes the isomorphism class
of $(\eset, \leq, \alf)$, symbols $\apom,\apom', \dots$ (resp.
$\aR, \aR', \dots$) range over (resp. sets of) pomsets, and we assume
that pomsets $\apom$ contain at least one lposet which will possibly
be referred to as $(\esetof \apom$, $\leqof \apom, \alfof \apom)$.
%
The empty pomset is denoted as $\emptypom$.

An event $\ae$ is an \emph{immediate predecessor} of an event $\ae'$
(or equivalently $\ae'$ is an \emph{immediate successor} of $\ae$) in
a pomset $\apom$ if $\ae \neq \ae'$, $\ae \leqof \apom \ae'$, and for
all $\ae'' \in \esetof \apom$ such that
$\ae \leqof \apom \ae'' \leqof \apom \ae'$ either $\ae = \ae''$ or
$\ae' = \ae''$.
%
We will represent pomsets as (a variant\footnote{Edges of Hasse
  diagrams are usually not oriented; here we use arrows so to draw
  order relations between events also horizontally.} of) Hasse
diagrams of the immediate predecessor relation; for instance, the
pomset
\[
  \left[\{\ae_1,\ae_2,\ae_3,\ae_4\}, \{(\ae_1,\ae_2),(\ae_1,\ae_3),
    (\ae_1,\ae_4), (\ae_4,\ae_5)\},
    \alf:
    \begin{cases}
      \ae_1 \mapsto \apref[\ptp p][]
      \\
      \ae_2,\ae_3 \mapsto \apref[][{\amulti q}]
      \\
      \ae_4 \mapsto \apref[\amulti R][][@][@][.]
      \\
      \ae_5 \mapsto \apref[][\amulti R][@][@][.]
    \end{cases}
  \right]
\]
is more conveniently written as
\[
  \pomsetrep{
    \node (out) {$\ae_1$};
    \node[below left = of out] (in1) {$\ae_2$};
    \node[below right = of out] (in2) {$\ae_3$};
    \node[above right = of in2] (out2) {$\ae_4$};
    \node[below = of out2] (in3) {$\ae_5$};
    \draw[->] (out) -- (in1);
    \draw[->] (out) -- (in2);
    \draw[->] (out) -- (out2);
    \draw[->] (out2) -- (in3);
  }[\alf][][node distance = .5cm and .3cm]
  \qquad\text{or}\qquad
  \pomsetrep{
    \node (out) {$\apref[{\ptp p}][]$};
    \node[below left = of out] (in1) {$\apref[][{\amulti q}]$};
    \node[below right = of out] (in2) {$\apref[][{\amulti q}]$};
    \node[above right = of in2] (out2) {$\apref[\amulti R][][@][@][.]$};
    \node[below = of out2] (in3) {$\apref[][\amulti R][@][@][.]$};
    \draw[->] (out) -- (in1);
    \draw[->] (out) -- (in2);
    \draw[->] (out) -- (out2);
    \draw[->] (out2) -- (in3);
  }[][][node distance = .5cm and .1cm]
\]
  
% Given an uncoordinated prefix $\apref$, we let $\pomsetsingle$ to be
% the pomset with a single event labelled by $\apref$.
%
We will use the auxiliary operations on pomsets described below.
%
Define (disjoing) union of two pomsets $\apom$ and $\apom'$ as
\[
  \apom \pomsetcup \apom' =
  [\esetof{\apom} \uplus \esetof{\apom'},
  \leqof{\apom} \uplus \leqof{\apom'},
  \alfof{\apom} \uplus \alfof{\apom'}]
\]
The sequential composition of $\apom$ and $\apom'$ composes an
instance of $\apom'$ with every maximal event of $\apom$.
%
Formally, for each $\ae \in \max \apom$, let
$\apom'_{\ae} = [\{\ae\} \times \eset_{\apom'}, \leq, \alf]$ where
$(\ae,\ae_1) \leq (\ae,\ae_2) \iff \ae_1 \leqof{\apom'} \ae_2$ and
$\alfof{\apom'_{\ae}} = (\ae,\ae') \mapsto \alfof{\apom'}(\ae')$ for
all $\ae' \in \esetof{\apom'}$.
%
Observe that $\apom'_{\ae}$ is isomorphic to $\apom'$, and define
\[
  \rseq[\apom][\apom'] = 
  [\esetof{\apom} \uplus \bigcup_{\ae \in \max \apom}\esetof{\apom'_{\ae}},
  \leq,
  \alfof{\apom} \uplus \bigcup_{\ae \in \max \apom}\alfof{\apom'_{\ae}}]
\]
where
$\leq = \leqof{\apom} \cup \bigcup_{\ae \in \max
  \apom}\leqof{\apom'_{\ae}} \cup \leqof{\apom'} \cup
\{(\ae,(\ae,\ae')) \sst \ae \in \max \apom \land (\ae,\ae') \in \min
{\apom'_{\ae}} \land \roles{\alfof{\apom}(\ae)} =
\roles{\alfof{\apom'}(\ae')}\}$ (recall that the labels of events are
uncoordinated prefixes for which $\roles{}$ is a singleton).
%
\eMnote{quando $\leq = \leqof{\apom} \uplus \leqof{\apom'}$ abbiamo il parallelo}
%
Finally, for $h \geq 1$ and a pomset $\apom$ we define
\[
  \apom^h =
  \begin{cases}
    r & \text{if } h = 1
    \\
    r \pomsetcup r^{h-1} & \text{if } h > 1
  \end{cases}
\]
The operation $\_^h$ extends element-wise to sets of pomsets.

The semantics of a global type builds upon \emph{basic pomsets} $\bp$
of prefixes $\apref$; in fact, the semantics of a global type is build
by taking sets of disjoint unions of basic pomsets of prefixes
sequentially composed together.
%
Let $\arole,\arole' \in \multiroles$ and $h \geq 0$

\begin{align*}
  \bp =
  &
    \begin{cases}
      \left\{ \pomsetrep{\node {$\apref$}}[] \right\},
      & \text{if $\apref$ uncoordinated } \land \roles{\apref} \subseteq \participants \cup \multiroles^\unknownop
      \\
      \bigcup_{h \geq 1}\big(\pomsetrep{\node {$\apref$}}[])^h,
      & \text{if $\apref$ uncoordinated } \land \roles{\apref} \not\subseteq \participants \cup \multiroles^\unknownop
    \end{cases}
  \\
  \bp[@][{\apref[\arole][\arole'][@][@][.]}] =
  &
    \begin{cases}
      \left\{ \pomsetrep{
        \node (out) {$\apref[\arole][][@][@][.]$};
        \node[below = of out] (in) {$\apref[][\arole'][@][@][.]$};
        \draw[->] (out) -- (in);
      }[]\right\},
      &
      \text{if } \arole' \in \participants \cup \multiroles^\unknownop
      \\
      \left\{\pomsetrep{
        \node (out) {$\apref[\arole][]$};
        \node[below left = of out] (rd1) {$\ae_1$};
        \node[below = of out] (dots) {};
        \node[below right = of out] (rd2) {$\ae_h$};
        \draw[->] (out) -- (rd1);
        \draw[->] (out) -- (rd2);
        \draw[dotted] (rd1) -- (rd2);
      }[(\ae_i \mapsto {\apref[][\arole'][@][@][.]})_{1 \leq i \leq h}][][node distance = 1cm and .25cm]\right\},
    &
    \text{otherwise}
    \end{cases}
  \\
  \bp[@][{\apref[\arole][\arole']}] =
  &
    \left\{\pomsetrep{
    \node (out) {$\apref[\arole][]$};
    \node[below left = of out] (rd1) {$\ae_1$};
    \node[below = of out] (dots) {};
    \node[below right = of out] (rd2) {$\ae_h$};
    \node[below = of dots] (in) {$\apref[][\arole']$};
    \draw[->] (out) -- (rd1);
    \draw[->] (out) -- (rd2);
    \draw[->] (rd1) -- (in);
    \draw[->] (rd2) -- (in);
    \draw[dotted] (rd1) -- (rd2);
    }[(\ae_i \mapsto {\apref[][\arole'][@][@][.]})_{1 \leq i \leq h}][][node distance = 1cm and .25cm]\right\}
\end{align*}

\begin{align*}
  \ksem{\apref} =
  &
    \bigcup_{h \geq 1}\big(\bp[@][\apref]\big)^h,
  \qquad \text{if $\apref$ uncoordinated}
  \\
  \ksem{\apref[\arole][\arole'][@][@][.]} =
  &
    \begin{cases}
      \bigcup_{h \geq 1}\bp[@][{\apref[\arole][\arole'][@][@][.]}],
      & \text{if } \arole \in \participants % \land \arole' \in \participants \cup \multiroles^\unknownop
      \\
      \bigcup_{k \geq 1}\bigcup_{h \geq 1}\big(\bp[@][{\apref[\arole][\arole'][@][@][.]}]\big)^k,
      & \text{if } \arole \not\in \participants % \land \arole' \in \participants \cup \multiroles^\unknownop
    \end{cases}
  \\
  \ksem{\apref[\arole][\arole']} =
  &
    \begin{cases}
      \bigcup_{h \geq 1}\bp[@][{\apref[\arole][\arole']}],
      & \text{if } \arole \in \participants % \land \arole' \in \participants \cup \multiroles^\unknownop
      \\
      \bigcup_{k \geq 1}\bigcup_{h \geq 1}\big(\bp[@][{\apref[\arole][\arole']}]\big)^k,
      & \text{if } \arole \not\in \participants % \land \arole' \in \participants \cup \multiroles^\unknownop
    \end{cases}
  \\
  \ksem \asum =
  &
    \begin{cases}
      \{ \emptypom \}, & \text{if } I = \emptyset
      \\
      \bigcup_{\apom \in \ksem{\apref_i},\apom' \in \ksem{\aK_i}} \rseq[\apom][\apom'],
      & \text{otherwise}
    \end{cases}
\end{align*}
\eMnote{solo unfolding finiti?}
The semantics of $\arec$ is the union of the semantics of all
unfoldings of $\arec$.




%%% Local Variables:
%%% mode: latex
%%% TeX-master: "main"
%%% End:
